# è·¯ç”±é©±åŠ¨å¼¹çª—æ¨¡å¼å®Œæ•´æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è·¯ç”±é©±åŠ¨å¼¹çª—æ¨¡å¼æ˜¯ä¸€ç§ç°ä»£åŒ–çš„å‰ç«¯æ¶æ„æ¨¡å¼ï¼Œé€šè¿‡URLçŠ¶æ€æ¥æ§åˆ¶æ¨¡æ€æ¡†çš„æ˜¾ç¤ºå’Œéšè—ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’ŒSEOæ”¯æŒã€‚

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. **URLå¯åˆ†äº«**
- å¯ä»¥ç›´æ¥é€šè¿‡URLæ‰“å¼€ç‰¹å®šçš„æ¨¡æ€æ¡†çŠ¶æ€
- æ”¯æŒæµè§ˆå™¨å‰è¿›/åé€€æŒ‰é’®
- å¯ä»¥æ”¶è—å’Œåˆ†äº«æ¨¡æ€æ¡†é“¾æ¥

### 2. **çŠ¶æ€ç®¡ç†ç®€åŒ–**
- æ— éœ€æ‰‹åŠ¨ç®¡ç†æ¨¡æ€æ¡†çš„æ˜¾ç¤º/éšè—çŠ¶æ€
- è·¯ç”±å³çŠ¶æ€ï¼Œå‡å°‘çŠ¶æ€ç®¡ç†å¤æ‚åº¦
- è‡ªåŠ¨å¤„ç†æ¨¡æ€æ¡†å…³é—­é€»è¾‘

### 3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
- æ”¯æŒæµè§ˆå™¨åé€€æŒ‰é’®å…³é—­æ¨¡æ€æ¡†
- ESCé”®å…³é—­æ¨¡æ€æ¡†
- æ›´è‡ªç„¶çš„å¯¼èˆªä½“éªŒ

### 4. **å¼€å‘æ•ˆç‡æå‡**
- ç»Ÿä¸€çš„æ¨¡æ€æ¡†ç®¡ç†æ–¹å¼
- å‡å°‘ç¡¬ç¼–ç è·¯ç”±
- æ›´å¥½çš„ä»£ç å¯ç»´æŠ¤æ€§

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### URLç»“æ„è®¾è®¡
```
é¡µé¢è·¯ç”±:     /system/menu/page
åˆ›å»ºæ¨¡æ€æ¡†:    /system/menu/modal/create
ç¼–è¾‘æ¨¡æ€æ¡†:    /system/menu/modal/edit/123
æŸ¥çœ‹æ¨¡æ€æ¡†:    /system/menu/modal/view/123
```

### ç»„ä»¶æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AdminLayout                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   SideNav   â”‚  â”‚     Content     â”‚   â”‚
â”‚  â”‚             â”‚  â”‚                 â”‚   â”‚
â”‚  â”‚  - èœå•ç®¡ç†  â”‚  â”‚  é¡µé¢å†…å®¹       â”‚   â”‚
â”‚  â”‚  - ç”¨æˆ·ç®¡ç†  â”‚  â”‚                 â”‚   â”‚
â”‚  â”‚  - è§’è‰²ç®¡ç†  â”‚  â”‚                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                   â”‚  GlobalModal    â”‚   â”‚
â”‚                   â”‚  (è·¯ç”±é©±åŠ¨)      â”‚   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶å’ŒHooks

### 1. ReactRouteModalç»„ä»¶
**ä½ç½®**: `components/ui/ReactRouteModal.tsx`

**åŠŸèƒ½**: æ ¸å¿ƒè·¯ç”±æ¨¡æ€æ¡†ç»„ä»¶ï¼Œè‡ªåŠ¨è§£æURLå¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†

```tsx
// åŸºæœ¬ç”¨æ³•
<ReactRouteModal
  basePath="system/menu"
  actions={['create', 'edit', 'view']}
  defaultConfig={{ width: 800 }}
>
  {(params, close) => (
    <MenuForm
      id={params.id}
      mode={params.action}
      onSuccess={close}
      onCancel={close}
    />
  )}
</ReactRouteModal>
```

### 2. useRouteModalV2 Hook
**ä½ç½®**: `hooks/useRouteModalV2.ts`

**åŠŸèƒ½**: æä¾›æ¨¡æ€æ¡†æ“ä½œæ–¹æ³•

```tsx
const routeModal = useRouteModalV2({
  basePath: 'system/menu',
  actions: ['create', 'edit', 'view'],
  actionTitles: {
    create: 'åˆ›å»º',
    edit: 'ç¼–è¾‘',
    view: 'æŸ¥çœ‹'
  },
  resourceName: 'èœå•'
});

// æ‰“å¼€åˆ›å»ºæ¨¡æ€æ¡†
routeModal.openModal('create');

// æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
routeModal.openModal('edit', { id: '123' });

// æ£€æŸ¥å½“å‰çŠ¶æ€
if (routeModal.isAction('edit')) {
  // ç¼–è¾‘æ¨¡å¼
}
```

### 3. useSimpleRouteModal Hook
**åŠŸèƒ½**: ç®€åŒ–ç‰ˆæ¨¡æ€æ¡†Hook

```tsx
const routeModal = useSimpleRouteModal('system/menu', 'èœå•');

// å¿«é€Ÿæ‰“å¼€æ¨¡æ€æ¡†
routeModal.openModal('create');
routeModal.openModal('edit', { id: '123' });
```

### 4. useRouteModalV2 Hook (å®Œæ•´ç‰ˆ)
**ä½ç½®**: `hooks/useRouteModalV2.ts`

**åŠŸèƒ½**: æä¾›å®Œæ•´çš„æ¨¡æ€æ¡†ç®¡ç†åŠŸèƒ½

```tsx
const routeModal = useRouteModalV2({
  basePath: 'system/menu',
  actions: ['create', 'edit', 'view'],
  actionTitles: {
    create: 'æ–°å»ºèœå•',
    edit: 'ç¼–è¾‘èœå•',
    view: 'æŸ¥çœ‹èœå•'
  },
  resourceName: 'èœå•',
  defaultProps: {
    width: 800,
    closable: true,
    maskClosable: false
  }
});

// ä½¿ç”¨ç¤ºä¾‹
return (
  <div>
    <Button onClick={() => routeModal.openModal('create')}>
      æ–°å»ºèœå•
    </Button>

    <ReactRouteModal
      basePath="system/menu"
      actions={['create', 'edit', 'view']}
      defaultConfig={routeModal.config.defaultProps}
    >
      {(params, close) => (
        <MenuModalContent params={params} close={close} />
      )}
    </ReactRouteModal>
  </div>
);
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºæ¨¡æ€æ¡†é¡µé¢
```tsx
// app/(system)/system/menu/modal/[...slug]/page.tsx
'use client';

import { ReactRouteModal } from '@/components/ui/ReactRouteModal';
import MenuCreateModal from '@/components/modals/MenuCreateModal';
import MenuEditModal from '@/components/modals/MenuEditModal';

function MenuModalContent({ params, close }: { params: any; close: () => void }) {
  switch (params.action) {
    case 'create':
      return <MenuCreateModal onClose={close} />;
    case 'edit':
      return <MenuEditModal menuId={params.id} onClose={close} />;
    case 'view':
      return <MenuEditModal menuId={params.id} readOnly onClose={close} />;
    default:
      return <div>æœªçŸ¥çš„æ“ä½œç±»å‹</div>;
  }
}

export default function MenuModalPage() {
  return (
    <ReactRouteModal
      basePath="system/menu"
      actions={['create', 'edit', 'view']}
      defaultConfig={{ width: 680 }}
    >
      {(params, close) => <MenuModalContent params={params} close={close} />}
    </ReactRouteModal>
  );
}
```

### 2. åœ¨é¡µé¢ä¸­ä½¿ç”¨
```tsx
// app/(system)/system/menu/page.tsx
import { useSimpleRouteModal } from '@/hooks/useRouteModalV2';

export default function MenuManagementPage() {
  const routeModal = useSimpleRouteModal('system/menu', 'èœå•');

  return (
    <div>
      <Button onClick={() => routeModal.openModal('create')}>
        æ–°å»ºèœå•
      </Button>

      <Table
        columns={[
          {
            title: 'æ“ä½œ',
            render: (_, record) => (
              <Space>
                <Button onClick={() => routeModal.openModal('edit', { id: record.id })}>
                  ç¼–è¾‘
                </Button>
                <Button onClick={() => routeModal.openModal('view', { id: record.id })}>
                  æŸ¥çœ‹
                </Button>
              </Space>
            )
          }
        ]}
        dataSource={data}
      />
    </div>
  );
}
```

### 3. é…ç½®å…¨å±€æ¨¡æ€æ¡†æ”¯æŒ
```tsx
// components/layout/AdminLayout.tsx
const GLOBAL_MODAL_CONFIGS = [
  {
    basePath: 'system/menu',
    actions: ['create', 'edit', 'view'],
    defaultConfig: { width: 680 }
  },
  {
    basePath: 'system/user',
    actions: ['create', 'edit', 'view'],
    defaultConfig: { width: 800 }
  }
];

export function AdminLayout({ children }: { children: React.ReactNode }) {
  return (
    <Layout>
      {/* ... å¸ƒå±€å†…å®¹ ... */}

      {GLOBAL_MODAL_CONFIGS.map((config) => (
        <ReactRouteModal
          key={config.basePath}
          basePath={config.basePath}
          actions={config.actions}
          defaultConfig={config.defaultConfig}
        >
          {(params, close) => null} {/* å†…å®¹ç”±å…·ä½“é¡µé¢å¤„ç† */}
        </ReactRouteModal>
      ))}
    </Layout>
  );
}
```

## ğŸ›¡ï¸ è·¯ç”±å®ˆå«

### 1. åŸºæœ¬è·¯ç”±å®ˆå«
```tsx
import { useRouteGuard } from '@/hooks/useRouteGuard';

function App() {
  const routeGuard = useRouteGuard({
    enableAuthCheck: true,
    enablePermissionCheck: true,
    protectedPatterns: [/^\/system\/.*/],
    checkAuth: () => Boolean(localStorage.getItem('token')),
    checkPermission: (path) => {
      const permissions = JSON.parse(localStorage.getItem('userPermissions') || '[]');
      return PermissionUtils.hasAnyPermission([
        PermissionUtils.extractRequiredPermission(path)
      ], permissions);
    }
  });

  // å¦‚æœéªŒè¯å¤±è´¥ï¼Œç»„ä»¶ä¼šè‡ªåŠ¨é‡å®šå‘
  return <div>{/* åº”ç”¨å†…å®¹ */}</div>;
}
```

### 2. æ¨¡æ€æ¡†å®ˆå«
```tsx
import { useModalGuard } from '@/hooks/useRouteGuard';

function ModalGuardExample() {
  const modalGuard = useModalGuard({
    allowedBasePaths: ['system/menu', 'system/user'],
    allowedActions: ['create', 'edit', 'view'],
    checkModalPermission: (basePath, action, id) => {
      const permissions = JSON.parse(localStorage.getItem('userPermissions') || '[]');

      if (basePath === 'system/menu') {
        return permissions.includes(`sys:menu:${action}`);
      }

      return true;
    }
  });

  return <div>{/* å†…å®¹ */}</div>;
}
```

## ğŸ“± æµè§ˆå™¨å†å²è®°å½•ç®¡ç†

### 1. åŸºæœ¬å†å²ç®¡ç†
```tsx
import { useModalHistory } from '@/hooks/useModalHistory';

function HistoryExample() {
  const {
    isModalOpen,
    goBack,
    smartBack,
    closeModal
  } = useModalHistory({
    listenToPopState: true,
    customBackHandler: (current, previous) => {
      console.log('ä»', current, 'åé€€åˆ°', previous);
      return false; // ä½¿ç”¨é»˜è®¤å¤„ç†
    }
  });

  return (
    <div>
      <Button onClick={smartBack}>
        æ™ºèƒ½åé€€
      </Button>

      {isModalOpen && (
        <Button onClick={closeModal}>
          å…³é—­æ¨¡æ€æ¡†
        </Button>
      )}
    </div>
  );
}
```

### 2. é”®ç›˜å¿«æ·é”®æ”¯æŒ
```tsx
import { useModalKeyboardShortcuts } from '@/hooks/useModalHistory';

function KeyboardShortcutsExample() {
  useModalKeyboardShortcuts({
    onClose: () => console.log('ESCé”®æŒ‰ä¸‹'),
    onBack: () => console.log('Alt+å·¦ç®­å¤´æŒ‰ä¸‹'),
    enabled: true
  });

  return <div>{/* å†…å®¹ */}</div>;
}
```

## ğŸ”§ é«˜çº§é…ç½®

### 1. è‡ªå®šä¹‰æ¨¡æ€æ¡†é…ç½®
```tsx
const customModalConfig = {
  basePath: 'custom/module',
  actions: ['create', 'edit', 'view', 'approve', 'reject'],
  actionTitles: {
    create: 'æ–°å»ºé¡¹ç›®',
    edit: 'ç¼–è¾‘é¡¹ç›®',
    view: 'æŸ¥çœ‹é¡¹ç›®',
    approve: 'å®¡æ‰¹é¡¹ç›®',
    reject: 'æ‹’ç»é¡¹ç›®'
  },
  resourceName: 'é¡¹ç›®',
  defaultProps: {
    width: 1000,
    height: 600,
    closable: true,
    maskClosable: false,
    destroyOnClose: true,
    centered: true
  }
};
```

### 2. åŠ¨æ€è·¯ç”±ç”Ÿæˆ
```tsx
// åŠ¨æ€ç”Ÿæˆæ¨¡æ€æ¡†è·¯ç”±
const generateModalRoute = (basePath: string, action: string, params?: any) => {
  return RouteHelper.generateModalRoute(`${basePath}/page`, action, params?.id);
};

// ä½¿ç”¨ç¤ºä¾‹
const editRoute = generateModalRoute('system/user', 'edit', { id: '123' });
// ç»“æœ: "/system/user/modal/edit/123"
```

### 3. æ‰¹é‡æ¨¡æ€æ¡†ç®¡ç†
```tsx
import { useMultipleRouteModals } from '@/hooks/useRouteModalV2';

function MultipleModalsExample() {
  const { activeModal, openModal, closeModal } = useMultipleRouteModals([
    { key: 'menu', basePath: 'system/menu', actions: ['create', 'edit'] },
    { key: 'user', basePath: 'system/user', actions: ['create', 'edit'] },
    { key: 'role', basePath: 'system/role', actions: ['create', 'edit'] }
  ]);

  return (
    <div>
      <Button onClick={() => openModal('menu', 'create')}>
        æ–°å»ºèœå•
      </Button>

      <Button onClick={() => openModal('user', 'edit', { id: '123' })}>
        ç¼–è¾‘ç”¨æˆ·
      </Button>

      {activeModal && (
        <Button onClick={closeModal}>
          å…³é—­å½“å‰æ¨¡æ€æ¡†
        </Button>
      )}
    </div>
  );
}
```

## ğŸ¨ æœ€ä½³å®è·µ

### 1. URLå‘½åè§„èŒƒ
```typescript
// âœ… æ¨è
const goodUrls = {
  systemMenuPage: 'system/menu/page',
  systemUserEdit: 'system/user/modal/edit/123',
  dashboardAnalytics: 'dashboard/analytics/page'
};

// âŒ é¿å…
const badUrls = {
  systemMenuPage: '/system/menu', // ç¼ºå°‘/pageåç¼€
  systemUserEdit: '/system/user/edit?id=123', // ä½¿ç”¨æŸ¥è¯¢å‚æ•°
  randomPath: '/some/random/path' // ä¸ç¬¦åˆå‘½åè§„èŒƒ
};
```

### 2. æƒé™æ£€æŸ¥è§„èŒƒ
```typescript
// âœ… æ¨èçš„æƒé™æ£€æŸ¥
const checkPermission = (path: string, userPermissions: string[]) => {
  const permissionMap = {
    '/system/menu': 'sys:menu:list',
    '/system/user': 'sys:user:list',
    '/system/role': 'sys:role:list'
  };

  const requiredPermission = permissionMap[path];
  return requiredPermission ? userPermissions.includes(requiredPermission) : true;
};

// âœ… æ¨¡æ€æ¡†æƒé™æ£€æŸ¥
const checkModalPermission = (basePath: string, action: string) => {
  const permission = `sys:${basePath.split('/')[1]}:${action}`;
  return userPermissions.includes(permission);
};
```

### 3. é”™è¯¯å¤„ç†è§„èŒƒ
```typescript
// âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
const handleModalError = (error: Error, action: string) => {
  console.error(`æ¨¡æ€æ¡†æ“ä½œå¤±è´¥: ${action}`, error);
  message.error(`æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•`);

  // é”™è¯¯æ—¶è‡ªåŠ¨å…³é—­æ¨¡æ€æ¡†å¹¶è¿”å›åŸºç¡€é¡µé¢
  router.push(RouteHelper.generateRoute(`${basePath}/page`));
};
```

### 4. æ€§èƒ½ä¼˜åŒ–
```typescript
// âœ… ä½¿ç”¨æ‡’åŠ è½½
const LazyModalContent = React.lazy(() => import('./ModalContent'));

// âœ… ä½¿ç”¨é˜²æŠ–å¤„ç†é¢‘ç¹æ“ä½œ
const debouncedOpenModal = useMemo(
  () => debounce(routeModal.openModal, 300),
  [routeModal.openModal]
);

// âœ… ç¼“å­˜è·¯ç”±ç”Ÿæˆç»“æœ
const routeCache = new Map<string, string>();
const getCachedRoute = (basePath: string, action: string, id?: string) => {
  const key = `${basePath}:${action}:${id || ''}`;
  if (!routeCache.has(key)) {
    routeCache.set(key, RouteHelper.generateModalRoute(`${basePath}/page`, action, id));
  }
  return routeCache.get(key)!;
};
```

## ğŸ”§ è°ƒè¯•å’Œå¼€å‘

### 1. å¼€å‘ç¯å¢ƒè°ƒè¯•
```typescript
// å¼€å‘ç¯å¢ƒä¸‹çš„è°ƒè¯•ä¿¡æ¯
if (process.env.NODE_ENV === 'development') {
  console.log('ğŸ” Modal Debug Info:', {
    currentPath: pathname,
    isModalOpen: routeModal.isOpen,
    modalAction: routeModal.action,
    modalId: routeModal.id,
    history: modalHistory.history
  });
}
```

### 2. æµ‹è¯•ç”¨ä¾‹
```typescript
// Jestæµ‹è¯•ç¤ºä¾‹
describe('RouteModal', () => {
  it('should parse modal route correctly', () => {
    const result = parseReactModalRoute('/system/menu/modal/edit/123', 'system/menu', ['edit']);
    expect(result).toEqual({
      isOpen: true,
      params: { action: 'edit', id: '123' }
    });
  });

  it('should generate correct modal route', () => {
    const route = RouteHelper.generateModalRoute('system/menu/page', 'edit', '123');
    expect(route).toBe('/system/menu/modal/edit/123');
  });
});
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Reacté£æ ¼URLæŒ‡å—](./REACT_STYLE_URL_GUIDE.md)
- [è·¯ç”±å·¥å…·ç±»API](../utils/routeHelper.ts)
- [èœå•ç±»å‹å®šä¹‰](../types/menu.ts)
- [æƒé™ç®¡ç†](./PERMISSION_GUIDE.md)

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æµè§ˆå™¨å…¼å®¹æ€§**: ç¡®ä¿ç›®æ ‡æµè§ˆå™¨æ”¯æŒHistory API
2. **SEOå½±å“**: æ¨¡æ€æ¡†å†…å®¹ä¸ä¼šè¢«æœç´¢å¼•æ“ç´¢å¼•
3. **æ€§èƒ½è€ƒè™‘**: é¿å…åŒæ—¶æ‰“å¼€è¿‡å¤šæ¨¡æ€æ¡†
4. **ç§»åŠ¨ç«¯é€‚é…**: ç¡®ä¿æ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„ä½“éªŒ
5. **æ— éšœç¢æ”¯æŒ**: æ·»åŠ é€‚å½“çš„ARIAæ ‡ç­¾å’Œé”®ç›˜å¯¼èˆªæ”¯æŒ

é€šè¿‡è¿™å¥—å®Œæ•´çš„è·¯ç”±é©±åŠ¨å¼¹çª—ç³»ç»Ÿï¼Œä½ å¯ä»¥æ„å»ºç°ä»£åŒ–ã€ç”¨æˆ·å‹å¥½çš„ç®¡ç†ç•Œé¢ï¼Œæä¾›ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒå’Œå¼€å‘ä½“éªŒã€‚